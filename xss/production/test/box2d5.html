<!DOCTYPE html>
<html>
<head>
<title></title>
            <script type="text/javascript" src="../js/resig.js"></script>
            <script type="text/javascript" src="../js/event.js"></script>
            <script type="text/javascript" src="../js/utils.js"></script>
            <script type="text/javascript" src="../js/keys.js"></script>
            <script type="text/javascript" src="../js/ui.js"></script>
            <script type="text/javascript" src="../js/streamer.js"></script>
            <script type="text/javascript" src="../js/Box2dWeb-2.1.a.3.min.js"></script>
            <script type="text/javascript" src="../js/joint.js"></script>
            <script type="text/javascript" src="../js/spawner.js"></script>
<script type="text/javascript">
var drawingCanvas;	
var streamer;	
var g_ui;
var g_elapsed = -1;
var g_delta = 0.0;
var g_canvas;
var g_ui_root;
var application = {};
application.events = new ev.EventHolder();
var SoundUtils = new ui.SoundUtils();
		if(drawingCanvas){
			var client =
			{
				width: 600,
				height: 600,
				canvas: drawingCanvas
			};            						
			var ui_ = new ui.Manager(client, streamer);			
			var g_ui = ui_;
			var g_ui_root = ui_.root;
			var mouse_pressed = false;
		}		
		var streamer = new stream.Streamer();	
		var ResourceUtils = new stream.ResourceUtils();
        var   b2Vec2 = Box2D.Common.Math.b2Vec2
        ,  b2AABB = Box2D.Collision.b2AABB
        ,  b2Mat22 = Box2D.Common.Math.b2Mat22
        ,	b2BodyDef = Box2D.Dynamics.b2BodyDef
        ,	b2Body = Box2D.Dynamics.b2Body
        ,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
        ,	b2Fixture = Box2D.Dynamics.b2Fixture
        ,	b2World = Box2D.Dynamics.b2World
        ,	b2MassData = Box2D.Collision.Shapes.b2MassData
        ,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
        ,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
        ,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
        ,  	b2MouseJointDef =  Box2D.Dynamics.Joints.b2MouseJointDef
        , 	b2Transform = Box2D.Common.Math.b2Transform
		,	b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef
		,	b2Joint = Box2D.Dynamics.Joints.b2Joint
		,	b2PrismaticJointDef = Box2D.Dynamics.Joints.b2PrismaticJointDef
		,	b2PulleyJointDef = Box2D.Dynamics.Joints.b2PulleyJointDef
		,	b2WeldJointDef = Box2D.Dynamics.Joints.b2WeldJointDef
		,	b2LineJointDef = Box2D.Dynamics.Joints.b2LineJointDef
		,	b2DistanceJointDef = Box2D.Dynamics.Joints.b2DistanceJointDef
        ;
        var g_world = new b2World(
            new b2Vec2(0, 3)    //gravity
        ,  true                 //allow sleep
        );		
            var g_spawner_manager = new arcade.SpawnManager();
        var g_step_collisions = [];
        var contactListener = new Box2D.Dynamics.b2ContactListener;
        contactListener.BeginContact = function(contact, manifold) 
        {
            function get_collider(body)
            {
                if (body.host && ("collision" in body.host.events))
                    return body.host;
                return null;
            }
            var host1 = get_collider(contact.GetFixtureA().GetBody());
            var host2 = get_collider(contact.GetFixtureB().GetBody());
            if (host1)
                g_step_collisions.push({host1: host1, host2:contact.GetFixtureB().GetBody().host, contact: contact, manifold:manifold});
            if (host2)
                g_step_collisions.push({host1: host2, host2:contact.GetFixtureA().GetBody().host, contact: contact, manifold:manifold});
        };
        g_world.SetContactListener(contactListener);
        var g_world_scale = 30;
        var fixDef = new b2FixtureDef;
        var bodyDef = new b2BodyDef;
        function update_body_position(host)
        {
            var me = host.physics;
            if (me.xs_updating)
                return;
            var pos = new b2Vec2((host.x + host.w/2)/g_world_scale, (host.y + host.h/2)/g_world_scale);
            var rot = new b2Mat22();
            rot.Set(host.rotation);
            var xform = new b2Transform(pos, rot);
            me.SetTransform(xform);
        }
		var global_package = new stream.Package(streamer);	
                global_package.add_item(
            {
		id:				"__image1",
		resource_type:	RESOURCE_IMAGE,
		src:			"images/smile_sad_48.png",
		frame_width:	null,
		frame_height:	null,
		animations:		[]
});	
				var __image1;
				global_package.events.addListener("loaded", function()
				{
					__image1 = streamer.get_resource("__image1");
				});
                global_package.add_item(
            {
		id:				"__image2",
		resource_type:	RESOURCE_IMAGE,
		src:			"images/smile_grin_48.png",
		frame_width:	null,
		frame_height:	null,
		animations:		[]
});	
				var __image2;
				global_package.events.addListener("loaded", function()
				{
					__image2 = streamer.get_resource("__image2");
				});
                global_package.add_item(
            {
		id:				"__image3",
		resource_type:	RESOURCE_IMAGE,
		src:			"images/stone-12.jpg",
		frame_width:	null,
		frame_height:	null,
		animations:		[]
});	
				var __image3;
				global_package.events.addListener("loaded", function()
				{
					__image3 = streamer.get_resource("__image3");
				});
                global_package.add_item(
            {
		id:				"__image4",
		resource_type:	RESOURCE_IMAGE,
		src:			"images/img1.png",
		frame_width:	null,
		frame_height:	null,
		animations:		[]
});	
				var __image4;
				global_package.events.addListener("loaded", function()
				{
					__image4 = streamer.get_resource("__image4");
				});
		global_package.add_item({
			id:				"invalid_res",
			resource_type:	RESOURCE_IMAGE,
			src:			"images/no_res.png",
			frame_width:	null,
			frame_height:	null,
			animations:		[]
		});		
		global_package.load();	
    var canvas_position = {x:0, y:0};
function start(resolution)  
{  
	function updater()  
	{
		canvas_position = getElementPosition(drawingCanvas);
		var now   = new Date().getTime();
        if (g_elapsed < 0)
            g_delta = 0; //first update
        else
		    g_delta  = now - g_elapsed;  
        g_elapsed = now; 
        g_world.Step(1 / 60, 10, 10);
        g_world.DrawDebugData();
        g_world.ClearForces();
            g_spawner_manager.update(g_delta);
        //process collisions
        for(var i = 0; i < g_step_collisions.length; i++)
        {
            var info = g_step_collisions[i];
			info.host1.events.dispatch("collision", [info.host2, info.contact, info.manifold]);             
        }
        g_step_collisions = [];
        //process contacts
        function get_contact_handler(body)
        {
            if (body.host && ("contact" in body.host.events))
                return body.host;
            return null;
        }
        var cc = g_world.GetContactList();
        while(cc)
        {
            var host1 = get_contact_handler(cc.GetFixtureA().GetBody());
            var host2 = get_contact_handler(cc.GetFixtureB().GetBody());
            if (host1)
                host1.contact(host2, cc);
            if (host2)
                host2.contact(host1, cc);
            cc = cc.GetNext();
        }
        //synch
        var bb = g_world.GetBodyList();
        while(bb)
        {
            if (!bb.IsActive())
            {
                bb = bb.GetNext();
                continue;
            }    
            var angle = bb.GetAngle();
            var pos   = bb.GetTransform().position;
            if (bb.host)
            {
                var x = pos.x*g_world_scale;
                var y = pos.y*g_world_scale;
                bb.host.xs_updating = true;
                bb.host.position(x - bb.host.w/2, y - bb.host.h/2);
                bb.host.set_rotation(angle*180/Math.PI);
                bb.host.xs_updating = false;
            }
            bb = bb.GetNext();
        }
		application.events.dispatch("updates", []);			
		var context = g_canvas.getContext('2d');
		g_ui.update(g_delta, context);
		window.setTimeout(updater, resolution);  
	}    
	window.setTimeout(updater, resolution);  
}  
var __label1;var __label2;var __label3;var __label4;var __label5;var btn1;var btn2;var btn3;var btn4;var btn5;var btn6;var __floor1;var __floor2;var __floor3;var __floor4;
        var body_1 = ui.Image.extend(
    {
    init: function(
                manager
                ,
                parent
                ,
                src
                )
    {
			this._super(	
			manager,parent,src? src : "images/smile_grin_48.png");       
        this.events = new ev.EventHolder(); 
        var this__  = this;
				this.events.addListener('resized', function(cmp)
                {
                    if (cmp.physics)
                        g_world.DestroyBody(cmp.physics);
             fixDef.density = 1;
             fixDef.friction = 0.5;
             fixDef.restitution = 0.200000003;
             bodyDef.type = b2Body.b2_dynamicBody;
                    fixDef.shape = new b2CircleShape(21.5/g_world_scale);
            fixDef.isSensor = false;
                bodyDef.position.Set((cmp.x + cmp.w/2)/g_world_scale, (cmp.y + cmp.h/2)/g_world_scale);
            current_body = g_world.CreateBody(bodyDef);			
            current_body.CreateFixture(fixDef);
			current_body.mouse_joint = true;
                cmp.physics = current_body;			
                cmp.events.addListener('moved', update_body_position);
                current_body.host = cmp;
                }
				);
                if (this.w > 0 && this.h > 0)
                {
					this.events.dispatch("resized", [this]);          
                }
                this.RemoveFromWorld = function(keep_visual) 
                {
                    g_world.DestroyBody(this.physics);
                    if (!keep_visual)
                    {
                        this.parent.removeComponent(this);
                    }
                }
            this.set_height(50);
            this.set_width(50);
            this.events.dispatch("init", [this]);
            },
});
        var body_2 = ui.Image.extend(
    {
    init: function(
                manager
                ,
                parent
                ,
                src
                )
    {
			this._super(	
			manager,parent,src? src : "images/smile_sad_48.png");       
        this.events = new ev.EventHolder(); 
        var this__  = this;
				this.events.addListener('resized', function(cmp)
                {
                    if (cmp.physics)
                        g_world.DestroyBody(cmp.physics);
             fixDef.density = 1;
             fixDef.friction = 0.5;
             fixDef.restitution = 0.200000003;
             bodyDef.type = b2Body.b2_dynamicBody;
                    fixDef.shape = new b2CircleShape(21.5/g_world_scale);
            fixDef.isSensor = false;
                bodyDef.position.Set((cmp.x + cmp.w/2)/g_world_scale, (cmp.y + cmp.h/2)/g_world_scale);
            current_body = g_world.CreateBody(bodyDef);			
            current_body.CreateFixture(fixDef);
			current_body.mouse_joint = true;
                cmp.physics = current_body;			
                cmp.events.addListener('moved', update_body_position);
                current_body.host = cmp;
                }
				);
                if (this.w > 0 && this.h > 0)
                {
					this.events.dispatch("resized", [this]);          
                }
                this.RemoveFromWorld = function(keep_visual) 
                {
                    g_world.DestroyBody(this.physics);
                    if (!keep_visual)
                    {
                        this.parent.removeComponent(this);
                    }
                }
            this.set_height(50);
            this.set_width(50);
            this.events.dispatch("init", [this]);
            },
});
        var body_3 = ui.Image.extend(
    {
    init: function(
                manager
                ,
                parent
                ,
                src
                )
    {
			this._super(	
			manager,parent,src? src : "images/img1.png");       
        this.events = new ev.EventHolder(); 
        var this__  = this;
				this.events.addListener('resized', function(cmp)
                {
                    if (cmp.physics)
                        g_world.DestroyBody(cmp.physics);
             fixDef.density = 1;
             fixDef.friction = 0.5;
             fixDef.restitution = 0.200000003;
             bodyDef.type = b2Body.b2_dynamicBody;
                fixDef.shape = new b2PolygonShape;
                    fixDef.shape.SetAsBox(cmp.w/(2*g_world_scale), cmp.h/(2*g_world_scale));
            fixDef.isSensor = false;
                bodyDef.position.Set((cmp.x + cmp.w/2)/g_world_scale, (cmp.y + cmp.h/2)/g_world_scale);
            current_body = g_world.CreateBody(bodyDef);			
            current_body.CreateFixture(fixDef);
			current_body.mouse_joint = true;
                cmp.physics = current_body;			
                cmp.events.addListener('moved', update_body_position);
                current_body.host = cmp;
                }
				);
                if (this.w > 0 && this.h > 0)
                {
					this.events.dispatch("resized", [this]);          
                }
                this.RemoveFromWorld = function(keep_visual) 
                {
                    g_world.DestroyBody(this.physics);
                    if (!keep_visual)
                    {
                        this.parent.removeComponent(this);
                    }
                }
            this.set_height(50);
            this.set_width(50);
            this.events.dispatch("init", [this]);
            },
});
        var floor = ui.Image.extend(
    {
    init: function(
                manager
                ,
                parent
                ,
                src
                )
    {
			this._super(	
			manager,parent,src? src : "images/stone-12.jpg");       
        this.events = new ev.EventHolder(); 
        var this__  = this;
				this.events.addListener('resized', function(cmp)
                {
                    if (cmp.physics)
                        g_world.DestroyBody(cmp.physics);
             fixDef.density = 1;
             fixDef.friction = 0.5;
             fixDef.restitution = 0.200000003;
             bodyDef.type = b2Body.b2_staticBody;
                fixDef.shape = new b2PolygonShape;
                    fixDef.shape.SetAsBox(cmp.w/(2*g_world_scale), cmp.h/(2*g_world_scale));
            fixDef.isSensor = false;
                bodyDef.position.Set((cmp.x + cmp.w/2)/g_world_scale, (cmp.y + cmp.h/2)/g_world_scale);
            current_body = g_world.CreateBody(bodyDef);			
            current_body.CreateFixture(fixDef);
                cmp.physics = current_body;			
                cmp.events.addListener('moved', update_body_position);
                current_body.host = cmp;
                }
				);
                if (this.w > 0 && this.h > 0)
                {
					this.events.dispatch("resized", [this]);          
                }
                this.RemoveFromWorld = function(keep_visual) 
                {
                    g_world.DestroyBody(this.physics);
                    if (!keep_visual)
                    {
                        this.parent.removeComponent(this);
                    }
                }
            this.events.dispatch("init", [this]);
            },
});
        var my_body = ui.Image.extend(
    {
    init: function(
                manager
                ,
                parent
                ,
                src
                )
    {
			this._super(	
			manager,parent,src);       
        this.events = new ev.EventHolder(); 
        var this__  = this;
	this.events.addListener("collision", function(who)
	{    
	}
	);
		application.are_obj_events = true;
            this.events.dispatch("init", [this]);
            },
});
	application.events.addListener("keydown", function(keycode)
	{    
		if (keycode == LEFT_ARROW)
{
btn1.set_x(btn1.x - 5);
}
if (keycode == RIGHT_ARROW)
{
btn1.set_x(btn1.x + 5);
}
if (keycode == UP_ARROW)
{
btn1.set_y(btn1.y - 5);
}
if (keycode == DOWN_ARROW)
{
btn1.set_y(btn1.y + 5);
}
	}
	);
window.onload = function() 
{
        drawingCanvas = document.getElementById("myCanvas");
        g_canvas = drawingCanvas;
	if (drawingCanvas && drawingCanvas.getContext)
	{
		var client =
		{
			width: 600,
			height: 600,
			canvas: drawingCanvas
		};
		var ui_ = new ui.Manager(client, streamer);
		g_ui = ui_;
        g_ui_root = ui_.root;
     	ui_.load_resources(function()
		{
	drawingCanvas.onmousemove = function(ev)
	{
		ui_.mousemove(ev.clientX - canvas_position.x, ev.clientY - canvas_position.y);                  
	};
	drawingCanvas.onmousedown = function(ev)
	{
		ui_.mousedown(ev.clientX - canvas_position.x, ev.clientY - canvas_position.y);                  
	};
	drawingCanvas.onmouseup = function(ev)
	{
		ui_.mouseup(ev.clientX - canvas_position.x, ev.clientY - canvas_position.y);                  
	};		
	ui_.events.addListener("mousedown", function(x,y)
	{    
		application.events.dispatch("mousedown", [x, y]);
	});
	ui_.events.addListener("mouseup", function(x,y)
	{    
		application.events.dispatch("mouseup", [x, y]);
	});
	ui_.events.addListener("mousemove", function(x,y)
	{    
		application.events.dispatch("mousemove", [x, y]);
	});
	ui_.events.addListener("click", function(x,y)
	{    
		application.events.dispatch("click", [x, y]);
	});
	ui_.events.addListener("drag", function(x,y)
	{    
		application.events.dispatch("drag", [x, y]);
	});
	ui_.events.addListener("dragend", function(x,y)
	{    
		application.events.dispatch("dragend", [x, y]);
	});
	ui_.events.addListener("keyup", function(keycode)
	{    
		application.events.dispatch("keyup", [keycode]);
	});
	ui_.events.addListener("keydown", function(keycode)
	{    
		application.events.dispatch("keydown", [keycode]);
	});
	ui_.events.addListener("keypress", function(keycode)
	{    
		application.events.dispatch("keydown", [keycode]);
	});
		    __label1 = new ui.Label(g_ui_root.manager, g_ui_root, "11px Verdana");
		    __label2 = new ui.Label(g_ui_root.manager, g_ui_root, "11px Verdana");
		    __label3 = new ui.Label(g_ui_root.manager, g_ui_root, "11px Verdana");
		    __label4 = new ui.Label(g_ui_root.manager, g_ui_root, "11px Verdana");
		    __label5 = new ui.Label(g_ui_root.manager, g_ui_root, "11px Verdana");
		    btn1 = new body_1(g_ui_root.manager, g_ui_root, "images/smile_grin_48.png");
		    btn2 = new body_1(g_ui_root.manager, g_ui_root, "images/smile_grin_48.png");
		    btn3 = new body_2(g_ui_root.manager, g_ui_root, "images/smile_sad_48.png");
		    btn4 = new body_2(g_ui_root.manager, g_ui_root, "images/smile_sad_48.png");
		    btn5 = new body_3(g_ui_root.manager, g_ui_root, "images/img1.png");
		    btn6 = new body_3(g_ui_root.manager, g_ui_root, "images/img1.png");
		    __floor1 = new floor(g_ui_root.manager, g_ui_root, "images/stone-12.jpg");
		    __floor2 = new floor(g_ui_root.manager, g_ui_root, "images/stone-12.jpg");
		    __floor3 = new floor(g_ui_root.manager, g_ui_root, "images/stone-12.jpg");
		    __floor4 = new floor(g_ui_root.manager, g_ui_root, "images/stone-12.jpg");
__distance_joint1 = 
new joint.DistanceJoint(
btn1,btn2);
__weld_joint1 = 
new joint.WeldJoint(
btn3,btn4);
__pulley_joint1 = 
new joint.PulleyJoint(
btn5,btn6,100,100,500,500,1);
            __label1.set_x(200);
            __label1.set_y(75);
            __label1.text("The happy and sad smileys are connected. Will be?");
            __label2.set_x(200);
            __label2.set_y(95);
            __label2.text("Try to move any of them with the mouse");
            __label3.set_x(50);
            __label3.set_y(135);
            __label3.text("Some faces are happy because they are linked but can rotate freely...(distance joint)");
            __label4.set_x(50);
            __label4.set_y(155);
            __label4.text("Others are sad because they are glued together and have no free will...(weld joint)");
            __label5.set_x(50);
            __label5.set_y(175);
            __label5.text("The two cameras are connected with a pulley joint. Test it !!!");
            btn1.set_x(200);
            btn1.set_y(250);
            btn2.set_x(100);
            btn2.set_y(250);
            btn3.set_x(400);
            btn3.set_y(250);
            btn4.set_x(300);
            btn4.set_y(250);
            btn5.set_x(15);
            btn5.set_y(100);
            btn6.set_x(500);
            btn6.set_y(500);
            __floor1.set_x(0);
            __floor1.set_y(590);
            __floor1.set_width(600);
            __floor1.set_height(10);
            __floor2.set_x(0);
            __floor2.set_y(0);
            __floor2.set_width(10);
            __floor2.set_height(600);
            __floor3.set_x(0);
            __floor3.set_y(0);
            __floor3.set_width(600);
            __floor3.set_height(10);
            __floor4.set_x(590);
            __floor4.set_y(0);
            __floor4.set_width(10);
            __floor4.set_height(600);
            __distance_joint1.joint.SetLength(5);
			document.onkeydown = function(ev)
			{
				ui_.keydown(ev.keyCode);                  
			};
			document.onkeyup = function(ev)
			{
				ui_.keyup(ev.keyCode);                  
			};
			document.onkeypress = function(ev)
			{
				ui_.keypress(ev.keyCode);                  
			};
            application.events.dispatch("init", []);
            start();			
			ui_.draw(drawingCanvas.getContext('2d'));
		});
	}
}
</script>
</head>
<body>	
	<canvas id="myCanvas" width="600" height="600"
		style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>	
</body>
</html>
